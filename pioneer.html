<!DOCTYPE html>
<html>
<head>
<title>Pioneer Mini HTTP Controller</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDkuMS1jMDAxIDc5LmE4ZDQ3NTM0OSwgMjAyMy8wMy8yMy0xMzowNTo0NSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDI0LjcgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjRGNkE5N0E4NzMwQjExRUU4NkZBODJCRUIwN0NCNjAzIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjRGNkE5N0E5NzMwQjExRUU4NkZBODJCRUIwN0NCNjAzIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NEY2QTk3QTY3MzBCMTFFRTg2RkE4MkJFQjA3Q0I2MDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NEY2QTk3QTc3MzBCMTFFRTg2RkE4MkJFQjA3Q0I2MDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5AuXhwAAAAMFBMVEWenZ3///9BPz/DwcGwWVHwnpfm5ub50Mzx8fHgeG7nt7P96+na2tr15d50c3P6+fnqQqWMAAABC0lEQVR42syTwXLDIAxE1wiEsFXp//+2C0mnzjR2r9GB8dhPy2rB2P4pfBZgQAQkrwALYAhCrgCVzLZl4gpI5Db6Jm8U7PHoQB3AH5MWBctYepQKVcuzT3hg/2lDKekiZk9CqU3XmV+j9bVJuB1cVB98FNlWc6LW0ZMd7N+31BWGgJvKBIzo3ltXtoq4mey998FqjcnBlECZIbqampFf29WJUYDTEZiIiKpbsNwSZYqnrBwsNdcMdMD1WYE0yCmXFL6rlb6mCNPh4cjLcSczK7X9ns7SfQ1WiIzj7sIYNUa/u1EyicNcb4Cg08B7IKcJSHNcKHBSzsfSKw86v4rfXvvM8435hF/vW4ABAFS/C4NxIIF6AAAAAElFTkSuQmCC">
<style>
* {
	font-family: Tahoma, sans-serif;
	font-size: 14px;
	box-sizing: border-box
}

button {
	width: 80px;
	height: 80px;
	cursor: pointer;
	background: #CCC;
	border-radius: 4px;
	border: 1px #999 solid;
	background-repeat: no-repeat;
	background-size: 40px;
	background-position-x: center;
	background-position-y: 8px;
	padding-top: 48px;
	position: relative;
}

.land {
	background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgLTk2MCA5NjAgOTYwIiB3aWR0aD0iMjQiPjxwYXRoIGQ9Ik03NTQtMzI0IDEyMC01MDB2LTIyMGw2MCAyMCAyOCA4NCAxOTIgNTR2LTMxOGw4MCAyMCAxMTAgMzUwIDIwMCA1NnEyMyA2IDM2LjUgMjQuNVQ4NDAtMzg4cTAgMzMtMjcgNTN0LTU5IDExWk0xMjAtMTIwdi04MGg3MjB2ODBIMTIwWiIvPjwvc3ZnPg==')
}

.takeoff {
	background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgLTk2MCA5NjAgOTYwIiB3aWR0aD0iMjQiPjxwYXRoIGQ9Ik0xMjAtMTIwdi04MGg3MjB2ODBIMTIwWm03NC0yMDBMODAtNTE0bDYyLTEyIDcwIDYyIDE5Mi01Mi0xNjItMjc0IDc4LTI0IDI3NCAyNDYgMjAwLTU0cTMyLTkgNTggMTJ0MjYgNTZxMCAyMi0xMy41IDM5VDgzMC00OTJMMTk0LTMyMFoiLz48L3N2Zz4=')
}

.rotate-cw {
	background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgLTk2MCA5NjAgOTYwIiB3aWR0aD0iMjQiPjxwYXRoIGQ9Ik00NDAtODBxLTc1IDAtMTQwLjUtMjguNXQtMTE0LTc3cS00OC41LTQ4LjUtNzctMTE0VDgwLTQ0MHEwLTE1MCAxMDUtMjU1dDI1NS0xMDVoNmwtNjItNjIgNTYtNTggMTYwIDE2MC0xNjAgMTYwLTU2LTU4IDYyLTYyaC02cS0xMTcgMC0xOTguNSA4MS41VDE2MC00NDBxMCAxMTcgODEuNSAxOTguNVQ0NDAtMTYwcTM1IDAgNjktOC41dDY1LTI1LjVsNTggNThxLTQzIDI4LTkyIDQyVDQ0MC04MFptMjQwLTEyMEw0NDAtNDQwbDI0MC0yNDAgMjQwIDI0MC0yNDAgMjQwWm0wLTExNCAxMjYtMTI2LTEyNi0xMjYtMTI2IDEyNiAxMjYgMTI2Wm0wLTEyNloiLz48L3N2Zz4=')
}

.rotate-ccw {
	background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgLTk2MCA5NjAgOTYwIiB3aWR0aD0iMjQiPjxwYXRoIGQ9Ik01MjAtODBxLTUxIDAtMTAwLTE0dC05Mi00Mmw1OC01OHEzMSAxNyA2NSAyNS41dDY5IDguNXExMTcgMCAxOTguNS04MS41VDgwMC00NDBxMC0xMTctODEuNS0xOTguNVQ1MjAtNzIwaC02bDYyIDYyLTU2IDU4LTE2MC0xNjAgMTYwLTE2MCA1NiA1OC02MiA2Mmg2cTE1MCAwIDI1NSAxMDV0MTA1IDI1NXEwIDc1LTI4LjUgMTQwLjV0LTc3IDExNHEtNDguNSA0OC41LTExNCA3N1Q1MjAtODBaTTI4MC0yMDAgNDAtNDQwbDI0MC0yNDAgMjQwIDI0MC0yNDAgMjQwWm0wLTExNCAxMjYtMTI2LTEyNi0xMjYtMTI2IDEyNiAxMjYgMTI2Wm0wLTEyNloiLz48L3N2Zz4=')
}

.forward {
	background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM6dj0iaHR0cHM6Ly92ZWN0YS5pby9uYW5vIj48cGF0aCBkPSJNMTggMTBsLTEuNCAxLjRMMTMgNy44VjIwaC0yVjcuOGwtMy41IDMuNUw2IDEwbDYtNiA2IDZ6Ii8+PC9zdmc+')
}

.back {
	background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM6dj0iaHR0cHM6Ly92ZWN0YS5pby9uYW5vIj48cGF0aCBkPSJNMTIgMjBsLTYtNiAxLjUtMS40IDMuNSAzLjZWNGgydjEyLjJsMy42LTMuNkwxOCAxNGwtNiA2eiIvPjwvc3ZnPg==')
}

.left {
	background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM6dj0iaHR0cHM6Ly92ZWN0YS5pby9uYW5vIj48cGF0aCBkPSJNNCwxMmw2LTZsMS40LDEuNUw3LjgsMTFIMjB2Mkg3LjhsMy42LDMuNkwxMCwxOEw0LDEyeiIvPjwvc3ZnPg==')
}

.right {
	background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgLTk2MCA5NjAgOTYwIiB3aWR0aD0iMjQiPjxwYXRoIGQ9Im01NjAtMjQwLTU2LTU4IDE0Mi0xNDJIMTYwdi04MGg0ODZMNTA0LTY2Mmw1Ni01OCAyNDAgMjQwLTI0MCAyNDBaIi8+PC9zdmc+')
}
.tune {
	background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgLTk2MCA5NjAgOTYwIiB3aWR0aD0iMjQiPjxwYXRoIGQ9Ik00NDAtMTIwdi0yNDBoODB2ODBoMzIwdjgwSDUyMHY4MGgtODBabS0zMjAtODB2LTgwaDI0MHY4MEgxMjBabTE2MC0xNjB2LTgwSDEyMHYtODBoMTYwdi04MGg4MHYyNDBoLTgwWm0xNjAtODB2LTgwaDQwMHY4MEg0NDBabTE2MC0xNjB2LTI0MGg4MHY4MGgxNjB2ODBINjgwdjgwaC04MFptLTQ4MC04MHYtODBoNDAwdjgwSDEyMFoiLz48L3N2Zz4=')
}

.up {
	background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM6dj0iaHR0cHM6Ly92ZWN0YS5pby9uYW5vIj48bGluZWFyR3JhZGllbnQgaWQ9IkEiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iOC43NDEiIHkxPSIxNC45NSIgeDI9IjE1LjI1OSIgeTI9IjE0Ljk1Ij48c3RvcCBvZmZzZXQ9IjAiIHN0b3AtY29sb3I9IiMyNGU4MmUiLz48c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiMyNDZhMmUiLz48L2xpbmVhckdyYWRpZW50PjxwYXRoIGQ9Ik04LjcgOC42djExLjdjMCAuNiAxLjUgMS4xIDMuMyAxLjFzMy4zLS41IDMuMy0xLjFWOC42SDguN3oiIGZpbGw9InVybCgjQSkiLz48bGluZWFyR3JhZGllbnQgaWQ9IkIiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iNiIgeTE9IjYuOSIgeDI9IjE4IiB5Mj0iNi45Ij48c3RvcCBvZmZzZXQ9IjAiIHN0b3AtY29sb3I9IiMyNGU4MmUiLz48c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiMyNDZhMmUiLz48L2xpbmVhckdyYWRpZW50PjxwYXRoIGQ9Ik02IDguNmMxLjUgMS41IDMuNyAyLjUgNiAyLjVzNC41LS45IDYtMi41bC02LTYtNiA2eiIgZmlsbD0idXJsKCNCKSIvPjwvc3ZnPg==')
}

.down {
	background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM6dj0iaHR0cHM6Ly92ZWN0YS5pby9uYW5vIj48bGluZWFyR3JhZGllbnQgaWQ9IkEiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iOC43NDEiIHkxPSI5LjA2IiB4Mj0iMTUuMjU5IiB5Mj0iOS4wNiI+PHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjZTczNTA4Ii8+PHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNWYyNjAwIi8+PC9saW5lYXJHcmFkaWVudD48cGF0aCBkPSJNMTUuMyAxNS41VjMuOGMwLS42LTEuNS0xLjEtMy4zLTEuMXMtMy4zLjUtMy4zIDEuMXYxMS43aDYuNnoiIGZpbGw9InVybCgjQSkiLz48bGluZWFyR3JhZGllbnQgaWQ9IkIiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMTcuOTk4IiB5MT0iMTcuMTM0IiB4Mj0iNi4wMDIiIHkyPSIxNy4xMzQiPjxzdG9wIG9mZnNldD0iMCIgc3RvcC1jb2xvcj0iIzVmMjYwMCIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iI2U3MzUwOCIvPjwvbGluZWFyR3JhZGllbnQ+PHBhdGggZD0iTTE4IDE1LjRjLTEuNS0xLjUtMy43LTIuNS02LTIuNXMtNC41LjktNiAyLjVsNiA2IDYtNnoiIGZpbGw9InVybCgjQikiLz48L3N2Zz4=')
}

html, body {
	width: 100vw;
	height: 100vh;
	padding: 0;
	margin: 0;
	top: 0;
	left: 0;
	overflow: hidden;
}

body {
	background-color: #666;
	background-size: cover;
	background-repeat: no-repeat;
	background-position: center;
}

.stop {
	background-color: #C30;
}

button:hover {
	opacity: 0.8
}

button:disabled {
	opacity: 0.2
}

.green {
	color: #3C0;
}

.red {
	color: #C30;
}

.center-hv {
	position: absolute;
	left: 50%;
	top: 50%;
	-webkit-transform: translate(-50%, -50%);
	transform: translate(-50%, -50%)
}

.key:after {
	color: #159;
	position: absolute;
	top: 10px;
	right: 10px;
}

button.emergency {
	background: repeating-linear-gradient(
		45deg,
		#fae21a,
		#fae21a 10px,
		#563e1f 10px,
		#563e1f 20px
	);
	padding-top: 0;
	text-transform: uppercase;
	font-weight: bold;
	color: #FFF;
	font-size: 20px;
	text-shadow: 0 0 3px #000;
}

.key_w:after { content: 'W' }
.key_s:after { content: 'S' }
.key_a:after { content: 'A' }
.key_d:after { content: 'D' }

.key_q:after { content: 'Q' }
.key_e:after { content: 'E' }
.key_u:after { content: 'U' }
.key_j:after { content: 'J' }

.key_o:after { content: 'O' }
.key_l:after { content: 'L' }

span {
	font-size: 13px;
}
</style>
</head>
<body>
<div style="position: fixed; top: 10px; right: 10px; cursor: pointer; min-height: 42px; min-width: 42px; background-size: 32px; background-repeat: no-repeat; background-position: center; background-color: rgba(255, 255, 255, 0.2); border-radius: 4px" class="tune" onclick="toggleSettings()">
</div>
<div id="settings" style="position: fixed; top: 52px; right: 10px; display: none; background: rgba(255, 255, 255, 0.5); border-radius: 4px; padding: 10px">
<table border="0" cellpadding="10">
	<tr>
		<td>Move speed</td>
		<td><input type="range" min="10" max="100" id="SpeedMove" onchange="setSpeed(this.id, this.value)"></td>
		<td><span style="width: 36px; display: block" id="valueSpeedMove">?</span></td>
	</tr>
	<tr>
		<td>Turn speed</td>
		<td><input type="range" min="10" max="100" id="SpeedTurn" onchange="setSpeed(this.id, this.value)"></td>
		<td><span style="width: 36px; display: block" id="valueSpeedTurn">?</span></td>
	</tr>
	<tr>
		<td>Vert speed</td>
		<td><input type="range" min="10" max="100" id="SpeedVert" onchange="setSpeed(this.id, this.value)"></td>
		<td><span style="width: 36px; display: block" id="valueSpeedVert">?</span></td>
	</tr>
	<tr>
		<td colspan="3"><hr></td>
	</tr>
	<tr>
		<td>Timer interval</td>
		<td><input type="range" min="100" max="500" step="50" id="TimerValue" onchange="setTimerValue(this.value)"></td>
		<td><span style="width: 36px; display: block" id="valueTimerValue">?</span></td>
	</tr>
</table>
</div>

<div style="position: fixed; left: 10px; top: 10px; width: 32px; border-radius: 3px; border: 2px solid #FFF; padding: 2px; height: 20px; display: none; box-shadow: 0 0 2px #000; background: rgba(0,0,0,0.3)" id="battery-holder">
	<div id="battery" style="position: absolute; width: 0%; background: #FFF; height: 12px; border-radius: 2px"></div>
	<div id="battery-text" style="position: absolute; width: calc(100% - 4px); height: 12px; font-size: 9px; text-align: center; color: #000; text-shadow: 0 0 2px #FFF"></div>
	<div style="background: #FFF; width: 2px; height: 6px; position: absolute; left: calc(100% + 2px); top: 5px;">
</div>

<div style="position: fixed; right: 10px; bottom: 10px">
<div id="instructions">
		<ol>
		<li>Turn on the drone</li>
		<li>Connect to WiFi<br>"PioneerMiniXXXXXXXXXX"<br>using password "12345678"</li>
		</ol>
	</div>
	
	<div id="no-server" style="display: none; color: #C30; text-align: center">
		Cannot connect to server<br>"127.0.0.1:41017"
	</div>
	<table>
		<tr>
			<td><button onclick="req('liftoff')" class="takeoff key key_o" disabled>Takeoff</button></td>
			<td><button onclick="req('land')" class="land key key_l" disabled>Land</button></td>
			<td style="background: rgba(0,0,0,0.5); text-align: center;"><span id="conn">?</span><br/>
			<span id="dist" style="color: #FFF">0</span></td>
		</tr>
		<tr>
			<td>&nbsp;</td>
		</tr>		
		<tr>
			<td><button onclick="req('turnLeft')" class="rotate-ccw key key_q" disabled>Turn left</button></td>
			<td><button onclick="req('forward')" class="forward key key_w" disabled>Forward</button></td>
			<td><button onclick="req('turnRight')" class="rotate-cw key key_e" disabled>Turn right</button></td>
		</tr>
		<tr>
			<td><button onclick="req('left')" class="left key key_a" disabled>Left</button></td>
			<td><!--button onclick="req('land')" class="stop" disabled>Stop</button--></td>
			<td><button onclick="req('right')" class="right key key_d" disabled>Right</button></td>
		</tr>
		<tr>
			<td><button onclick="req('up')" class="up key key_u" disabled>Up</button></td>
			<td><button onclick="req('back')" class="back key key_s" disabled>Back</button></td>
			<td><button onclick="req('down')" class="down key key_j" disabled>Down</button></td>
		</tr>
		<tr>
			<td colspan="3"><button onclick="req('disarm')" class="key key_p emergency" disabled style="width: 100%;">EMERGENCY STOP</button></td>
		</tr>
	</table>
	
	<script>
	const serverUrl = "http://127.0.0.1:41017/?action="
	var isServerConnected = false
	function toggleSettings() {
		const sets = document.getElementById('settings')
		if (sets) {
			sets.style.display = sets.style.display === 'none' ? 'block' : 'none'
		}
	}
	
	function getLocalStorageItem(key, defaultValue = null) {
		const val = localStorage.getItem(key)
		if (val == null) return defaultValue
		return val
	}
	
	function req(str) {
		const noserver = document.getElementById('no-server')
		try {
			const xmlHttp = new XMLHttpRequest()
			xmlHttp.open("GET", serverUrl + str, false)
			xmlHttp.send(null)
			noserver.style.display = 'none'
			if (!isServerConnected) {
				isServerConnected = true
				updateAllSettings()
			}			
			return xmlHttp.responseText
		} catch (ex) {
			console.log('Server not connected')
			isServerConnected = false
			noserver.style.display = 'block'
		}
	}	
	
	function set(type, value, coef = 0.01, min = 10, max = 100, dim = '%') {
		value = parseInt(value)
		if (value < min) value = min
		else if (value > max) value = max
		const slider = document.getElementById(type)		
		if (slider && slider.value != value) {
			slider.value = value
		}
		const v = document.getElementById('value' + type)
		if (v) v.innerHTML = value + dim
		localStorage.setItem(type, value)
		req('set' + type + "&value=" + value*coef)
	}
	
	function setSpeed(type, value) {
		set(type, value)
	}
	
	function setTimerValue(value) {
		set('TimerValue', value, 1, 100, 500, "ms")
	}
	
	function updateAllSettings() {
		setSpeed('SpeedMove', getLocalStorageItem('SpeedMove', 100))
		setSpeed('SpeedTurn', getLocalStorageItem('SpeedTurn', 100))
		setSpeed('SpeedVert', getLocalStorageItem('SpeedVert', 100))
		
		setTimerValue(getLocalStorageItem('TimerValue', 200))
	}
	
	var commandCounter = 0
	var batteryQueryCounterMax = 10;
	const battery_max = 4.05
	const battery_min = 3.5
	
	function norm(value, min, max) {
		value = parseFloat(value)
		if (value < min) value = min
		else if (value > max) value = max
		return Math.round(100 * (value - min) / (max - min))
	}
	
	window.onload = function () {
		updateAllSettings()
		
		setInterval(function () {
			const conn = document.getElementById('conn')
			const dist = document.getElementById('dist')
			let connected = false
			let d = '?'
			let bat = null
			let cmd = 'frame'
			commandCounter++
			if (commandCounter >= batteryQueryCounterMax) {
				commandCounter = 0
				cmd += "&battery=true"
			}
			const resp = req(cmd)
			try {
				const json = JSON.parse(resp)
				if (typeof json.connected !== 'undefined') {
					connected = json.connected
				}			
				if (typeof json.d !== 'undefined') {
					d = json.d
				}
				if (typeof json.frame !== 'undefined') {
					document.body.style['background-image'] = "url(data:image/jpeg;base64,"+json.frame+")";
				}
				if (typeof json.battery !== 'undefined' && json.battery !== null) {
					bat = json.battery
				}
			} catch (ex) {
				console.warn(resp + ' is not valid json')
			}
			const btns = document.getElementsByTagName('button')
			for (let i = 0; i<btns.length; i++) {
				btns[i].disabled = !connected
			}	
			
			if (bat != null) {
				const batElement = document.getElementById('battery')
				const batTextElement = document.getElementById('battery-text')
				const batPercent = norm(bat, battery_min, battery_max)
				if (batElement) batElement.style.width = 'calc(' + batPercent + '% - 4px)'
				if (batTextElement) {
					batTextElement.title = bat + "V"
					batTextElement.innerHTML = batPercent + '%'
				}
			}
			
			conn.innerHTML = connected ? '<span class="green">Connected</span>' : '<span class="red">Disconnected</span>'
			dist.innerHTML = d + "m"
			document.getElementById('instructions').style.display = connected ? 'none' : 'block'
			document.getElementById('battery-holder').style.display = connected ? 'block' : 'none'
		}, 200)
		
		document.onkeypress = function (e) {
			e = e || window.event
			const k = e.keyCode
			if (k == 113) { // "q" - turn left
				req('turnLeft')
			} else if (k == 101) { // "e" - turn right 
				req('turnRight')
			} else if (k == 119) { // "w" - forward 
				req('forward')
			} else if (k == 115) { // "s" - back 
				req('back')
			} else if (k == 97) { // "a" - left 
				req('left')
			} else if (k == 100) { // "d" - left 
				req('right')
			} else if (k == 117) { // "u" - up 
				req('up')
			} else if (k == 106) { // "j" - down 
				req('down')
			} else if (k == 108) { // "l" - land
				req('land')
			} else if (k == 111) { // "o" - takeoff
				req('takeoff')
			}
		}	
	}	
	</script>
</div>
</body>
</html>